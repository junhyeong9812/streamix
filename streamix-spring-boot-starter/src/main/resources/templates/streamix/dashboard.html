<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{streamix/layout}">
<head>
  <title>대시보드</title>
</head>
<body>
<div layout:fragment="content">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">대시보드</h1>
    <p class="page-subtitle">미디어 스트리밍 서버 현황을 확인하세요</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${totalFiles}">0</div>
              <div class="stat-label">전체 파일</div>
            </div>
            <div class="stat-icon bg-primary-soft">
              <i class="bi bi-folder"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.activeSessions} ?: 0">0</div>
              <div class="stat-label">활성 세션</div>
              <span class="stat-change positive" th:if="${stats?.activeSessions > 0}">
                                <i class="bi bi-broadcast"></i> 스트리밍 중
                            </span>
            </div>
            <div class="stat-icon bg-success-soft">
              <i class="bi bi-broadcast"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.todaySessions} ?: 0">0</div>
              <div class="stat-label">오늘 스트리밍</div>
            </div>
            <div class="stat-icon bg-info-soft">
              <i class="bi bi-play-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.todayBytesFormatted} ?: '0 B'">0 B</div>
              <div class="stat-label">오늘 전송량</div>
            </div>
            <div class="stat-icon bg-warning-soft">
              <i class="bi bi-cloud-upload"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Recent Files -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span><i class="bi bi-clock-history me-2"></i>최근 업로드</span>
          <a th:href="@{${@streamixProperties.dashboard.path} + '/files'}"
             class="btn btn-sm btn-outline-streamix">
            전체 보기
          </a>
        </div>
        <div class="card-body p-0">
          <div th:if="${#lists.isEmpty(recentFiles)}" class="empty-state">
            <div class="empty-state-icon">
              <i class="bi bi-folder-x"></i>
            </div>
            <div class="empty-state-title">업로드된 파일이 없습니다</div>
            <div class="empty-state-text">파일 관리에서 새 파일을 업로드하세요</div>
          </div>

          <div th:unless="${#lists.isEmpty(recentFiles)}" class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
              <tr>
                <th>미리보기</th>
                <th>파일명</th>
                <th>타입</th>
                <th>크기</th>
                <th>업로드</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="file : ${recentFiles}">
                <td>
                  <img th:if="${file.thumbnailPath != null}"
                       th:src="@{${@streamixProperties.api.basePath} + '/files/' + ${file.id} + '/thumbnail'}"
                       class="thumbnail-preview" alt="썸네일">
                  <div th:unless="${file.thumbnailPath != null}"
                       class="file-icon" th:classappend="${file.type.name().toLowerCase()}">
                    <i th:class="${file.type.name() == 'VIDEO'} ? 'bi bi-camera-video' : 'bi bi-image'"></i>
                  </div>
                </td>
                <td>
                                        <span class="fw-medium text-truncate d-inline-block" style="max-width: 200px;"
                                              th:text="${file.originalName}" th:title="${file.originalName}"></span>
                </td>
                <td>
                                        <span class="badge"
                                              th:classappend="${file.type.name() == 'VIDEO'} ? 'bg-info' : 'bg-success'"
                                              th:text="${file.type}"></span>
                </td>
                <td>
                                        <span data-format="filesize" th:data-value="${file.size}"
                                              th:text="${#numbers.formatDecimal(file.size / 1024 / 1024, 1, 1)} + ' MB'"></span>
                </td>
                <td>
                                        <span class="text-muted small"
                                              th:text="${#temporals.format(file.createdAt, 'MM-dd HH:mm')}"></span>
                </td>
                <td>
                  <a th:href="@{${@streamixProperties.dashboard.path} + '/files/' + ${file.id}}"
                     class="btn btn-sm btn-outline-secondary btn-icon"
                     data-bs-toggle="tooltip" title="상세 보기">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Summary & Active Sessions -->
    <div class="col-lg-4">
      <!-- Stats Summary -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-graph-up me-2"></i>통계 요약
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <span class="text-muted">이번 달 스트리밍</span>
            <span class="fw-bold" th:text="${stats?.monthSessions} ?: 0">0</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <span class="text-muted">전체 스트리밍</span>
            <span class="fw-bold" th:text="${stats?.totalSessions} ?: 0">0</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <span class="text-muted">총 전송량</span>
            <span class="fw-bold" th:text="${stats?.totalBytesFormatted} ?: '0 B'">0 B</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">평균 스트리밍 시간</span>
            <span class="fw-bold" th:text="${stats?.avgDurationFormatted} ?: '-'">-</span>
          </div>
        </div>
      </div>

      <!-- Active Sessions -->
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span><i class="bi bi-broadcast me-2"></i>활성 세션</span>
          <span class="badge bg-success badge-status" th:if="${!#lists.isEmpty(activeSessions)}">
                        <span th:text="${#lists.size(activeSessions)}"></span> 활성
                    </span>
        </div>
        <div class="card-body">
          <div th:if="${#lists.isEmpty(activeSessions)}" class="text-center text-muted py-4">
            <i class="bi bi-wifi-off d-block mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
            <small>현재 활성 스트리밍 없음</small>
          </div>

          <div th:unless="${#lists.isEmpty(activeSessions)}">
            <div th:each="session, stat : ${activeSessions}"
                 class="d-flex align-items-center gap-3 py-2"
                 th:classappend="${!stat.last} ? 'border-bottom' : ''">
              <div class="session-status-dot active"></div>
              <div class="flex-grow-1">
                <div class="small fw-medium text-truncate" style="max-width: 150px;"
                     th:text="${session.fileId}" th:title="${session.fileId}"></div>
                <div class="text-muted small" th:text="${session.clientIp}"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popular Files -->
  <div class="card mt-4" th:if="${!#lists.isEmpty(popularFiles)}">
    <div class="card-header">
      <i class="bi bi-fire me-2"></i>인기 파일
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div th:each="popular : ${popularFiles}" class="col-md-4 col-lg-2">
          <div class="text-center p-3 rounded hover-lift cursor-pointer"
               style="background: var(--streamix-bg);">
            <i class="bi bi-play-circle d-block mb-2" style="font-size: 2rem; color: var(--streamix-primary);"></i>
            <div class="small text-truncate" th:text="${popular.fileId}" th:title="${popular.fileId}"></div>
            <div class="text-muted small">
              <span th:text="${popular.streamCount}"></span>회 재생
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>