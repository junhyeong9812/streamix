<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{streamix/layout}">
<head>
  <title>스트리밍 세션</title>
</head>
<body>
<div layout:fragment="content">
  <!-- Page Header -->
  <div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div>
      <h1 class="page-title">스트리밍 세션</h1>
      <p class="page-subtitle">실시간 스트리밍 현황을 모니터링합니다</p>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="autoRefresh">
      <label class="form-check-label" for="autoRefresh">자동 새로고침</label>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.activeSessions} ?: 0">0</div>
              <div class="stat-label">활성 세션</div>
            </div>
            <div class="stat-icon bg-success-soft">
              <i class="bi bi-broadcast"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.todaySessions} ?: 0">0</div>
              <div class="stat-label">오늘 스트리밍</div>
            </div>
            <div class="stat-icon bg-info-soft">
              <i class="bi bi-calendar-check"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.monthSessions} ?: 0">0</div>
              <div class="stat-label">이번 달 스트리밍</div>
            </div>
            <div class="stat-icon bg-primary-soft">
              <i class="bi bi-calendar-month"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-xl-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="stat-value" th:text="${stats?.totalBytesFormatted} ?: '0 B'">0 B</div>
              <div class="stat-label">총 전송량</div>
            </div>
            <div class="stat-icon bg-warning-soft">
              <i class="bi bi-cloud-upload"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Active Sessions -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
                    <span>
                        <i class="bi bi-broadcast me-2"></i>활성 세션
                        <span class="badge bg-success ms-2" th:if="${!#lists.isEmpty(activeSessions)}"
                              th:text="${#lists.size(activeSessions)} + ' 스트리밍 중'"></span>
                    </span>
        </div>
        <div class="card-body p-0">
          <div th:if="${#lists.isEmpty(activeSessions)}" class="empty-state py-5">
            <div class="empty-state-icon">
              <i class="bi bi-wifi-off"></i>
            </div>
            <div class="empty-state-title">활성 세션 없음</div>
            <div class="empty-state-text">현재 스트리밍 중인 세션이 없습니다</div>
          </div>

          <div th:unless="${#lists.isEmpty(activeSessions)}"
               id="activeSessionsTable" class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
              <tr>
                <th>상태</th>
                <th>파일 ID</th>
                <th>클라이언트 IP</th>
                <th>시작 시간</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="session : ${activeSessions}">
                <td>
                  <div class="session-status">
                    <span class="session-status-dot active"></span>
                    <span class="small" th:text="${session.status}"></span>
                  </div>
                </td>
                <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 120px;"
                                              th:text="${session.fileId}" th:title="${session.fileId}"></span>
                </td>
                <td th:text="${session.clientIp}"></td>
                <td>
                                        <span class="session-duration"
                                              th:data-start-time="${session.startedAt}"
                                              th:text="${#temporals.format(session.startedAt, 'HH:mm:ss')}"></span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Sessions -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <i class="bi bi-clock-history me-2"></i>최근 세션
        </div>
        <div class="card-body p-0">
          <div th:if="${#lists.isEmpty(recentSessions)}" class="empty-state py-5">
            <div class="empty-state-icon">
              <i class="bi bi-inbox"></i>
            </div>
            <div class="empty-state-title">세션 기록 없음</div>
            <div class="empty-state-text">아직 스트리밍 기록이 없습니다</div>
          </div>

          <div th:unless="${#lists.isEmpty(recentSessions)}" class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
              <tr>
                <th>상태</th>
                <th>파일 ID</th>
                <th>전송량</th>
                <th>소요 시간</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="session : ${recentSessions}">
                <td>
                                        <span class="badge"
                                              th:classappend="${session.status.name() == 'COMPLETED'} ? 'bg-success' :
                                                             (${session.status.name() == 'ERROR'} ? 'bg-danger' :
                                                             (${session.status.name() == 'CANCELLED'} ? 'bg-warning' : 'bg-secondary'))"
                                              th:text="${session.status}"></span>
                </td>
                <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 100px;"
                                              th:text="${session.fileId}" th:title="${session.fileId}"></span>
                </td>
                <td>
                  <span th:text="${#numbers.formatDecimal(session.bytesSent / 1024 / 1024, 1, 2)} + ' MB'"></span>
                </td>
                <td>
                                        <span th:if="${session.durationMs != null}"
                                              th:text="${session.durationMs < 1000} ? (${session.durationMs} + 'ms') :
                                                       (${#numbers.formatDecimal(session.durationMs / 1000, 1, 1)} + 's')">-</span>
                  <span th:unless="${session.durationMs != null}">-</span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Stats -->
  <div class="row g-4 mt-0">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-graph-up me-2"></i>통계 요약
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-3">
              <div class="text-center p-3 rounded" style="background: var(--streamix-bg);">
                <div class="fs-3 fw-bold text-primary" th:text="${stats?.totalSessions} ?: 0">0</div>
                <div class="text-muted small">전체 스트리밍 횟수</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 rounded" style="background: var(--streamix-bg);">
                <div class="fs-3 fw-bold text-success" th:text="${stats?.todayBytesFormatted} ?: '0 B'">0 B</div>
                <div class="text-muted small">오늘 전송량</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 rounded" style="background: var(--streamix-bg);">
                <div class="fs-3 fw-bold text-info" th:text="${stats?.monthBytesFormatted} ?: '0 B'">0 B</div>
                <div class="text-muted small">이번 달 전송량</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 rounded" style="background: var(--streamix-bg);">
                <div class="fs-3 fw-bold text-warning" th:text="${stats?.avgDurationFormatted} ?: '-'">-</div>
                <div class="text-muted small">평균 스트리밍 시간</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>